%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                        %
%      This file is part of the 'lilyglyphs' LaTeX package.              %
%                                ==========                              %
%                                                                        %
%              https://github.com/uliska/lilyglyphs                      %
%                                                                        %
%  Copyright 2012-2013, 2019 Urs Liska and others, git@ursliska.de       %
%                                                                        %
%  'lilyglyphs' is free software: you can redistribute it and/or modify  %
%  it under the terms of the LaTeX Project Public License, either        %
%  version 1.3 of this license or (at your option) any later version.    %
%  You may find the latest version of this license at                    %
%               http://www.latex-project.org/lppl.txt                    %
%  more information on                                                   %
%               http://latex-project.org/lppl/                           %
%  and version 1.3 or later is part of all distributions of LaTeX        %
%  version 2005/12/01 or later.                                          %
%                                                                        %
%  This work has the LPPL maintenance status 'maintained'.               %
%  The Current Maintainer of this work is Urs Liska (see above).         %
%                                                                        %
%  This work consists of the files listed in the file 'manifest.txt'     %
%  which can be found in the 'license' directory.                        %
%                                                                        %
%  This program is distributed in the hope that it will be useful,       %
%  but WITHOUT ANY WARRANTY; without even the implied warranty of        %
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                  %
%                                                                        %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lilyglyphs}

\RequirePackage{ifluatex,ifxetex}

\ifluatex
\else
\typeout{}
\typeout{lyluatex works with LuaLaTeX exclusively,}
\typeout{aborting compilation.}
\typeout{}
\ifxetex
\typeout{To continue using the package with XeLaTeX}
\typeout{please use the fork `xelilyglyphs` instead.}
\typeout
\fi
\stop
\fi

\RequirePackage{fontspec}

% Create a vertically stacked box (time signatures)
\RequirePackage[export]{adjustbox}

% Use luaformatters (and luaoptions)
\RequirePackage{luaformatters}

\directlua{
    _opts = lua_options
    _opts.register('lilyglyphs', {
      ['font'] = { 'emmentaler' },
      ['weight'] = { '16', '11', '13', '14', '18', '20', '23', '26' },
      ['scale'] = { '1', _opts.is_num },
      ['voffset'] = { '0', _opts.is_dim },
    })
}

\addLuaFormatters{lilyglyphs-core.lua}
\lilySetFont{emmentaler}

% Add a “library” to lilyglyphs
% (actually a luaformatters “client”)
% - #1: library name
%       has to be unique among all lilyglyphs libraries
%       (within one document, including all loaded packages),
%       will internally be prefixed with lilyglyphs-
% - #2: Lua module filename
%       Name of a file (which has to be available to 'require')
%       This file must return a templatestable.
\newcommand*{\addLilyglyphsLibrary}[1]{%
  \directlua{
    lilyglyphs:add_library(
        require(kpse.find_file([[\string#1]]) or [[\string#1]]))
  }
}

\addLilyglyphsLibrary{lilyglyphs-accidentals}
\addLilyglyphsLibrary{lilyglyphs-clefs}
\addLilyglyphsLibrary{lilyglyphs-spanners}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TODO: Everything from here on is legacy code %
%                                              %

%%%%%%%%%%%%%%%%%%%%%%
% Core functionality %

% include logic and functionality to create dotted symbols
%\input{core/dotted.inp}

% Core functionality %
%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Definitions of the glyphs in groups                  %
% corresponding to the glyph list in the LilyPond docs %

% \input{commands/timesignatures.inp}

%\input{commands/noteheads.inp}

% \input{commands/rests.inp}
%
% \input{commands/scripts.inp}
%
% \input{commands/accordion.inp}

% Definitions of complex glyphs created with LilyPond
% and included as image files

% \input{commands/singlenotes.inp}
%
% \input{commands/beamednotes.inp}
%
% \input{commands/fancyexamples.inp}

% End of command definitions %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% lilyglyphs logo to be used in texts about lilyglyphs
% created by genGlyphCommands.py on 2012-11-10
% \newcommand*{\lilyglyphs}[1][]{%
%     \setkeys{lilyDesignOptions}{scale=0.97,raise=-0.78}%
%     \lilyPrintImage[#1]{lilyglyphs_logo}%
% }
